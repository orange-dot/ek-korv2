/**
 * @file font.c
 * @brief Bitmap font implementation for EK-OS
 *
 * 8x16 bitmap font based on VGA font style.
 * Each character is stored as 16 bytes (16 rows of 8 bits).
 */

#include "font.h"
#include "fb.h"

/* 8x16 bitmap font data for ASCII 32-126 (95 chars)
 * Each character is 16 bytes (16 rows), MSB is leftmost pixel */
static const uint8_t font_data[95][16] = {
    /* Space (32) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* ! (33) */
    {0x00, 0x00, 0x18, 0x3c, 0x3c, 0x3c, 0x18, 0x18,
     0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    /* " (34) */
    {0x00, 0x66, 0x66, 0x66, 0x24, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* # (35) */
    {0x00, 0x00, 0x00, 0x6c, 0x6c, 0xfe, 0x6c, 0x6c,
     0x6c, 0xfe, 0x6c, 0x6c, 0x00, 0x00, 0x00, 0x00},
    /* $ (36) */
    {0x18, 0x18, 0x7c, 0xc6, 0xc2, 0xc0, 0x7c, 0x06,
     0x06, 0x86, 0xc6, 0x7c, 0x18, 0x18, 0x00, 0x00},
    /* % (37) */
    {0x00, 0x00, 0x00, 0x00, 0xc2, 0xc6, 0x0c, 0x18,
     0x30, 0x60, 0xc6, 0x86, 0x00, 0x00, 0x00, 0x00},
    /* & (38) */
    {0x00, 0x00, 0x38, 0x6c, 0x6c, 0x38, 0x76, 0xdc,
     0xcc, 0xcc, 0xcc, 0x76, 0x00, 0x00, 0x00, 0x00},
    /* ' (39) */
    {0x00, 0x30, 0x30, 0x30, 0x60, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* ( (40) */
    {0x00, 0x00, 0x0c, 0x18, 0x30, 0x30, 0x30, 0x30,
     0x30, 0x30, 0x18, 0x0c, 0x00, 0x00, 0x00, 0x00},
    /* ) (41) */
    {0x00, 0x00, 0x30, 0x18, 0x0c, 0x0c, 0x0c, 0x0c,
     0x0c, 0x0c, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00},
    /* * (42) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x3c, 0xff,
     0x3c, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* + (43) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7e,
     0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* , (44) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00},
    /* - (45) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* . (46) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    /* / (47) */
    {0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x0c, 0x18,
     0x30, 0x60, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00},
    /* 0 (48) */
    {0x00, 0x00, 0x38, 0x6c, 0xc6, 0xc6, 0xd6, 0xd6,
     0xc6, 0xc6, 0x6c, 0x38, 0x00, 0x00, 0x00, 0x00},
    /* 1 (49) */
    {0x00, 0x00, 0x18, 0x38, 0x78, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x7e, 0x00, 0x00, 0x00, 0x00},
    /* 2 (50) */
    {0x00, 0x00, 0x7c, 0xc6, 0x06, 0x0c, 0x18, 0x30,
     0x60, 0xc0, 0xc6, 0xfe, 0x00, 0x00, 0x00, 0x00},
    /* 3 (51) */
    {0x00, 0x00, 0x7c, 0xc6, 0x06, 0x06, 0x3c, 0x06,
     0x06, 0x06, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* 4 (52) */
    {0x00, 0x00, 0x0c, 0x1c, 0x3c, 0x6c, 0xcc, 0xfe,
     0x0c, 0x0c, 0x0c, 0x1e, 0x00, 0x00, 0x00, 0x00},
    /* 5 (53) */
    {0x00, 0x00, 0xfe, 0xc0, 0xc0, 0xc0, 0xfc, 0x06,
     0x06, 0x06, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* 6 (54) */
    {0x00, 0x00, 0x38, 0x60, 0xc0, 0xc0, 0xfc, 0xc6,
     0xc6, 0xc6, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* 7 (55) */
    {0x00, 0x00, 0xfe, 0xc6, 0x06, 0x06, 0x0c, 0x18,
     0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00},
    /* 8 (56) */
    {0x00, 0x00, 0x7c, 0xc6, 0xc6, 0xc6, 0x7c, 0xc6,
     0xc6, 0xc6, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* 9 (57) */
    {0x00, 0x00, 0x7c, 0xc6, 0xc6, 0xc6, 0x7e, 0x06,
     0x06, 0x06, 0x0c, 0x78, 0x00, 0x00, 0x00, 0x00},
    /* : (58) */
    {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
     0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* ; (59) */
    {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
     0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00},
    /* < (60) */
    {0x00, 0x00, 0x00, 0x06, 0x0c, 0x18, 0x30, 0x60,
     0x30, 0x18, 0x0c, 0x06, 0x00, 0x00, 0x00, 0x00},
    /* = (61) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00,
     0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* > (62) */
    {0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0c, 0x06,
     0x0c, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00},
    /* ? (63) */
    {0x00, 0x00, 0x7c, 0xc6, 0xc6, 0x0c, 0x18, 0x18,
     0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    /* @ (64) */
    {0x00, 0x00, 0x00, 0x7c, 0xc6, 0xc6, 0xde, 0xde,
     0xde, 0xdc, 0xc0, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* A (65) */
    {0x00, 0x00, 0x10, 0x38, 0x6c, 0xc6, 0xc6, 0xfe,
     0xc6, 0xc6, 0xc6, 0xc6, 0x00, 0x00, 0x00, 0x00},
    /* B (66) */
    {0x00, 0x00, 0xfc, 0x66, 0x66, 0x66, 0x7c, 0x66,
     0x66, 0x66, 0x66, 0xfc, 0x00, 0x00, 0x00, 0x00},
    /* C (67) */
    {0x00, 0x00, 0x3c, 0x66, 0xc2, 0xc0, 0xc0, 0xc0,
     0xc0, 0xc2, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00},
    /* D (68) */
    {0x00, 0x00, 0xf8, 0x6c, 0x66, 0x66, 0x66, 0x66,
     0x66, 0x66, 0x6c, 0xf8, 0x00, 0x00, 0x00, 0x00},
    /* E (69) */
    {0x00, 0x00, 0xfe, 0x66, 0x62, 0x68, 0x78, 0x68,
     0x60, 0x62, 0x66, 0xfe, 0x00, 0x00, 0x00, 0x00},
    /* F (70) */
    {0x00, 0x00, 0xfe, 0x66, 0x62, 0x68, 0x78, 0x68,
     0x60, 0x60, 0x60, 0xf0, 0x00, 0x00, 0x00, 0x00},
    /* G (71) */
    {0x00, 0x00, 0x3c, 0x66, 0xc2, 0xc0, 0xc0, 0xde,
     0xc6, 0xc6, 0x66, 0x3a, 0x00, 0x00, 0x00, 0x00},
    /* H (72) */
    {0x00, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xfe, 0xc6,
     0xc6, 0xc6, 0xc6, 0xc6, 0x00, 0x00, 0x00, 0x00},
    /* I (73) */
    {0x00, 0x00, 0x3c, 0x18, 0x18, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00},
    /* J (74) */
    {0x00, 0x00, 0x1e, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c,
     0xcc, 0xcc, 0xcc, 0x78, 0x00, 0x00, 0x00, 0x00},
    /* K (75) */
    {0x00, 0x00, 0xe6, 0x66, 0x66, 0x6c, 0x78, 0x78,
     0x6c, 0x66, 0x66, 0xe6, 0x00, 0x00, 0x00, 0x00},
    /* L (76) */
    {0x00, 0x00, 0xf0, 0x60, 0x60, 0x60, 0x60, 0x60,
     0x60, 0x62, 0x66, 0xfe, 0x00, 0x00, 0x00, 0x00},
    /* M (77) */
    {0x00, 0x00, 0xc6, 0xee, 0xfe, 0xfe, 0xd6, 0xc6,
     0xc6, 0xc6, 0xc6, 0xc6, 0x00, 0x00, 0x00, 0x00},
    /* N (78) */
    {0x00, 0x00, 0xc6, 0xe6, 0xf6, 0xfe, 0xde, 0xce,
     0xc6, 0xc6, 0xc6, 0xc6, 0x00, 0x00, 0x00, 0x00},
    /* O (79) */
    {0x00, 0x00, 0x7c, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6,
     0xc6, 0xc6, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* P (80) */
    {0x00, 0x00, 0xfc, 0x66, 0x66, 0x66, 0x7c, 0x60,
     0x60, 0x60, 0x60, 0xf0, 0x00, 0x00, 0x00, 0x00},
    /* Q (81) */
    {0x00, 0x00, 0x7c, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6,
     0xc6, 0xd6, 0xde, 0x7c, 0x0c, 0x0e, 0x00, 0x00},
    /* R (82) */
    {0x00, 0x00, 0xfc, 0x66, 0x66, 0x66, 0x7c, 0x6c,
     0x66, 0x66, 0x66, 0xe6, 0x00, 0x00, 0x00, 0x00},
    /* S (83) */
    {0x00, 0x00, 0x7c, 0xc6, 0xc6, 0x60, 0x38, 0x0c,
     0x06, 0xc6, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* T (84) */
    {0x00, 0x00, 0x7e, 0x7e, 0x5a, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00},
    /* U (85) */
    {0x00, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6,
     0xc6, 0xc6, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* V (86) */
    {0x00, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6,
     0xc6, 0x6c, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00},
    /* W (87) */
    {0x00, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xd6, 0xd6,
     0xd6, 0xfe, 0xee, 0x6c, 0x00, 0x00, 0x00, 0x00},
    /* X (88) */
    {0x00, 0x00, 0xc6, 0xc6, 0x6c, 0x7c, 0x38, 0x38,
     0x7c, 0x6c, 0xc6, 0xc6, 0x00, 0x00, 0x00, 0x00},
    /* Y (89) */
    {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x18,
     0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00},
    /* Z (90) */
    {0x00, 0x00, 0xfe, 0xc6, 0x86, 0x0c, 0x18, 0x30,
     0x60, 0xc2, 0xc6, 0xfe, 0x00, 0x00, 0x00, 0x00},
    /* [ (91) */
    {0x00, 0x00, 0x3c, 0x30, 0x30, 0x30, 0x30, 0x30,
     0x30, 0x30, 0x30, 0x3c, 0x00, 0x00, 0x00, 0x00},
    /* \ (92) */
    {0x00, 0x00, 0x00, 0x80, 0xc0, 0xe0, 0x70, 0x38,
     0x1c, 0x0e, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00},
    /* ] (93) */
    {0x00, 0x00, 0x3c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c,
     0x0c, 0x0c, 0x0c, 0x3c, 0x00, 0x00, 0x00, 0x00},
    /* ^ (94) */
    {0x10, 0x38, 0x6c, 0xc6, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* _ (95) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00},
    /* ` (96) */
    {0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* a (97) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x0c, 0x7c,
     0xcc, 0xcc, 0xcc, 0x76, 0x00, 0x00, 0x00, 0x00},
    /* b (98) */
    {0x00, 0x00, 0xe0, 0x60, 0x60, 0x78, 0x6c, 0x66,
     0x66, 0x66, 0x66, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* c (99) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0xc6, 0xc0,
     0xc0, 0xc0, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* d (100) */
    {0x00, 0x00, 0x1c, 0x0c, 0x0c, 0x3c, 0x6c, 0xcc,
     0xcc, 0xcc, 0xcc, 0x76, 0x00, 0x00, 0x00, 0x00},
    /* e (101) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0xc6, 0xfe,
     0xc0, 0xc0, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* f (102) */
    {0x00, 0x00, 0x38, 0x6c, 0x64, 0x60, 0xf0, 0x60,
     0x60, 0x60, 0x60, 0xf0, 0x00, 0x00, 0x00, 0x00},
    /* g (103) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xcc, 0xcc,
     0xcc, 0xcc, 0xcc, 0x7c, 0x0c, 0xcc, 0x78, 0x00},
    /* h (104) */
    {0x00, 0x00, 0xe0, 0x60, 0x60, 0x6c, 0x76, 0x66,
     0x66, 0x66, 0x66, 0xe6, 0x00, 0x00, 0x00, 0x00},
    /* i (105) */
    {0x00, 0x00, 0x18, 0x18, 0x00, 0x38, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00},
    /* j (106) */
    {0x00, 0x00, 0x06, 0x06, 0x00, 0x0e, 0x06, 0x06,
     0x06, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3c, 0x00},
    /* k (107) */
    {0x00, 0x00, 0xe0, 0x60, 0x60, 0x66, 0x6c, 0x78,
     0x78, 0x6c, 0x66, 0xe6, 0x00, 0x00, 0x00, 0x00},
    /* l (108) */
    {0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00},
    /* m (109) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xec, 0xfe, 0xd6,
     0xd6, 0xd6, 0xd6, 0xc6, 0x00, 0x00, 0x00, 0x00},
    /* n (110) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xdc, 0x66, 0x66,
     0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00},
    /* o (111) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0xc6, 0xc6,
     0xc6, 0xc6, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* p (112) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xdc, 0x66, 0x66,
     0x66, 0x66, 0x66, 0x7c, 0x60, 0x60, 0xf0, 0x00},
    /* q (113) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xcc, 0xcc,
     0xcc, 0xcc, 0xcc, 0x7c, 0x0c, 0x0c, 0x1e, 0x00},
    /* r (114) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xdc, 0x76, 0x66,
     0x60, 0x60, 0x60, 0xf0, 0x00, 0x00, 0x00, 0x00},
    /* s (115) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0xc6, 0x60,
     0x38, 0x0c, 0xc6, 0x7c, 0x00, 0x00, 0x00, 0x00},
    /* t (116) */
    {0x00, 0x00, 0x10, 0x30, 0x30, 0xfc, 0x30, 0x30,
     0x30, 0x30, 0x36, 0x1c, 0x00, 0x00, 0x00, 0x00},
    /* u (117) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xcc, 0xcc, 0xcc,
     0xcc, 0xcc, 0xcc, 0x76, 0x00, 0x00, 0x00, 0x00},
    /* v (118) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66,
     0x66, 0x66, 0x3c, 0x18, 0x00, 0x00, 0x00, 0x00},
    /* w (119) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xc6, 0xc6, 0xd6,
     0xd6, 0xd6, 0xfe, 0x6c, 0x00, 0x00, 0x00, 0x00},
    /* x (120) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xc6, 0x6c, 0x38,
     0x38, 0x38, 0x6c, 0xc6, 0x00, 0x00, 0x00, 0x00},
    /* y (121) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xc6, 0xc6, 0xc6,
     0xc6, 0xc6, 0xc6, 0x7e, 0x06, 0x0c, 0xf8, 0x00},
    /* z (122) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xcc, 0x18,
     0x30, 0x60, 0xc6, 0xfe, 0x00, 0x00, 0x00, 0x00},
    /* { (123) */
    {0x00, 0x00, 0x0e, 0x18, 0x18, 0x18, 0x70, 0x18,
     0x18, 0x18, 0x18, 0x0e, 0x00, 0x00, 0x00, 0x00},
    /* | (124) */
    {0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18,
     0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    /* } (125) */
    {0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0e, 0x18,
     0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00},
    /* ~ (126) */
    {0x00, 0x00, 0x76, 0xdc, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
};

void font_init(void) {
    /* Nothing to initialize - font data is static */
}

void font_char(int x, int y, char c, uint32_t fg) {
    font_char_bg(x, y, c, fg, 0);
}

void font_char_bg(int x, int y, char c, uint32_t fg, uint32_t bg) {
    if (!fb_available()) return;

    /* Map character to font index */
    int idx = (unsigned char)c - 32;
    if (idx < 0 || idx >= 95) {
        idx = 0;  /* Default to space for unprintable chars */
    }

    const uint8_t *glyph = font_data[idx];

    for (int row = 0; row < FONT_HEIGHT; row++) {
        uint8_t bits = glyph[row];
        for (int col = 0; col < FONT_WIDTH; col++) {
            int px = x + col;
            int py = y + row;

            if (bits & (0x80 >> col)) {
                fb_pixel(px, py, fg);
            } else if (bg != 0) {
                fb_pixel(px, py, bg);
            }
        }
    }
}

void font_string(int x, int y, const char *s, uint32_t fg) {
    if (!s) return;

    int cx = x;
    while (*s) {
        if (*s == '\n') {
            cx = x;
            y += FONT_HEIGHT;
        } else {
            font_char(cx, y, *s, fg);
            cx += FONT_WIDTH;
        }
        s++;
    }
}

void font_string_bg(int x, int y, const char *s, uint32_t fg, uint32_t bg) {
    if (!s) return;

    int cx = x;
    while (*s) {
        if (*s == '\n') {
            cx = x;
            y += FONT_HEIGHT;
        } else {
            font_char_bg(cx, y, *s, fg, bg);
            cx += FONT_WIDTH;
        }
        s++;
    }
}

int font_text_width(const char *s) {
    if (!s) return 0;

    int width = 0;
    int max_width = 0;
    while (*s) {
        if (*s == '\n') {
            if (width > max_width) max_width = width;
            width = 0;
        } else {
            width += FONT_WIDTH;
        }
        s++;
    }
    return (width > max_width) ? width : max_width;
}
