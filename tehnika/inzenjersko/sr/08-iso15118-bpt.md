# ISO 15118-20 Dvosmerni Prenos Snage (BPT)

Ovaj dokument detaljno opisuje implementaciju ISO 15118-20 protokola za V2G dvosmerni prenos snage u ELEKTROKOMBINACIJA sistemu.

---

## 1. Pregled Protokola

### 1.1 Evolucija ISO 15118

```
ISO 15118-2 (2014)              ISO 15118-20 (2022)
────────────────────────────────────────────────────────────────
Samo jednosmerno              →   Dvosmerni Prenos Snage (BPT)
AC i DC punjenje              →   AC, DC i bežično punjenje
Planirano punjenje            →   Planirani I Dinamički modovi
EXI kodiranje                 →   EXI kodiranje (optimizovano)
TLS 1.2                       →   TLS 1.3
Ograničeni servisi            →   Prošireni servisni okvir
```

### 1.2 Ključne V2G Funkcije u ISO 15118-20

| Funkcija | Opis |
|----------|------|
| **DC_BPT** | Dvosmerni DC servis prenosa snage |
| **Dinamički Režim** | Podešavanje snage u realnom vremenu od strane EVSE |
| **Planirani Režim** | Unapred planirani raspored punjenja/pražnjenja |
| **Režim Kontrole** | Grid-following ili Grid-forming rad |
| **BPT Parametri** | Limiti snage pražnjenja, energetski limiti |

### 1.3 Protokol Stek

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         APLIKACIONI SLOJ                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  V2G Aplikacioni Protokol                                          │ │
│  │  ├─ Upravljanje Sesijom                                            │ │
│  │  ├─ Otkrivanje i Izbor Servisa                                     │ │
│  │  ├─ Autorizacija (PnC / EIM)                                       │ │
│  │  ├─ Otkrivanje Parametara Punjenja                                 │ │
│  │  ├─ Razmena Rasporeda                                              │ │
│  │  └─ Isporuka Snage i Petlja Punjenja                               │ │
│  └───────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│                        PREZENTACIONI SLOJ                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  EXI (Efficient XML Interchange)                                   │ │
│  │  ├─ Kodiranje zasnovano na šemi                                    │ │
│  │  ├─ Binarna XML reprezentacija                                     │ │
│  │  └─ ~10x kompresija u odnosu na tekstualni XML                     │ │
│  └───────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│                           SESIJSKI SLOJ                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  TLS 1.3                                                           │ │
│  │  ├─ Međusobna autentikacija (za PnC)                               │ │
│  │  ├─ ECDSA potpisi                                                  │ │
│  │  └─ AES-GCM enkripcija                                             │ │
│  └───────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│                         TRANSPORTNI SLOJ                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  TCP/IP                                                            │ │
│  │  ├─ Port 15118 (V2G komunikacija)                                  │ │
│  │  └─ Pouzdana, uređena isporuka                                     │ │
│  └───────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│                          FIZIČKI SLOJ                                    │
│  ┌────────────────────────────┐  ┌────────────────────────────┐       │
│  │  HomePlug Green PHY (PLC)  │  │  WiFi (opciono)            │       │
│  │  ├─ Preko Control Pilot    │  │  ├─ 802.11n                │       │
│  │  ├─ 10 Mbps max            │  │  └─ Za bežično punjenje    │       │
│  │  └─ SLAC asocijacija       │  │                            │       │
│  └────────────────────────────┘  └────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Otkrivanje i Izbor Servisa

### 2.1 Dostupni Servisi

```
ServiceID   Ime Servisa         Opis
─────────────────────────────────────────────────────────────────
1           DC                  Jednosmerno DC punjenje
2           DC_ACDP             DC sa AC tokom pauze
3           AC                  AC punjenje
4           AC_BPT              Dvosmerni AC (budućnost)
5           WPT                 Bežični Prenos Snage
6           DC_BPT              Dvosmerni DC ← V2G SERVIS
7           DC_ACDP_BPT         DC ACDP sa dvosmernim
```

### 2.2 Razmena Otkrivanja Servisa

```
EVCC (Vozilo)                                     SECC (Punjač)
     │                                                 │
     │────── ServiceDiscoveryReq ─────────────────────►│
     │       {                                         │
     │         SupportedServiceIDs: [1, 6]             │
     │       }                                         │
     │                                                 │
     │◄───── ServiceDiscoveryRes ─────────────────────│
     │       {                                         │
     │         ResponseCode: OK,                       │
     │         ServiceList: [                          │
     │           {ServiceID: 1, ServiceName: "DC"},    │
     │           {ServiceID: 6, ServiceName: "DC_BPT"} │ ← V2G dostupan
     │         ]                                       │
     │       }                                         │
     │                                                 │
     │────── ServiceSelectionReq ─────────────────────►│
     │       {                                         │
     │         SelectedServiceList: [                  │
     │           {ServiceID: 6, ParameterSetID: 1}     │ ← Izaberi BPT
     │         ]                                       │
     │       }                                         │
```

---

## 3. BPT Mašina Stanja

### 3.1 Kompletni Dijagram Stanja

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       ISO 15118-20 BPT MAŠINA STANJA                             │
│                                                                                  │
│                              ┌─────────┐                                        │
│                     ┌───────►│  IDLE   │◄────────────────────────────┐          │
│                     │        └────┬────┘                             │          │
│                     │             │ Kabl povezan                     │          │
│                     │             │ SLAC završen                     │          │
│                     │             ▼                                  │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │ SUPPORTED_APP_   │                        │          │
│                     │   │ PROTOCOL         │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │  SESSION_SETUP   │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │  AUTHORIZATION   │ PnC ili EIM            │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │SERVICE_DISCOVERY │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │SERVICE_SELECTION │ Izaberi DC_BPT         │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│    Renegocijacija   │   │ CHARGE_PARAMETER │ Razmena BPT limita     │          │
│    Sesije       ────┤   │ DISCOVERY        │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │SCHEDULE_EXCHANGE │ Samo SCHEDULED režim   │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │   CABLE_CHECK    │ Test izolacije         │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │   PRE_CHARGE     │ Uskladi napon baterije │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │ POWER_DELIVERY   │ Zatvori kontaktore     │          │
│                     │   │ START            │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌────────────────────────────────────────┐  │          │
│                     │   │          DC_BPT_CHARGE_LOOP            │  │          │
│                     │   │  ┌──────────────────────────────────┐  │  │          │
│                     │   │  │                                  │  │  │          │
│                     │   │  │  EVTargetPower > 0 → PUNJENJE    │  │  │          │
│                     │   │  │  EVTargetPower < 0 → PRAŽNJENJE  │◄─┼──┼──┐       │
│                     │   │  │  EVTargetPower = 0 → MIROVANJE   │  │  │  │       │
│                     │   │  │                                  │──┼──┼──┘       │
│                     │   │  └──────────────────────────────────┘  │  │  petlja  │
│                     │   └────────────────────┬───────────────────┘  │          │
│                     │                        │                      │          │
│                     │                        │ ChargingComplete     │          │
│                     │                        ▼                      │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │ POWER_DELIVERY   │ Otvori kontaktore      │          │
│                     │   │ STOP             │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     └───│  SESSION_STOP    │────────────────────────┘          │
│                         └──────────────────┘                                    │
│                                                                                  │
│  Legenda:                                                                       │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  PUNJENJE:    Snaga teče Mreža → Baterija (EVTargetPower > 0)                  │
│  PRAŽNJENJE:  Snaga teče Baterija → Mreža (EVTargetPower < 0) [V2G]            │
│  MIROVANJE:   Nema prenosa snage (EVTargetPower = 0)                           │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Režimi Kontrole

### 4.1 PLANIRANI Režim

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        TOK PLANIRANOG REŽIMA                             │
│                                                                          │
│  EVCC šalje:                                                             │
│  ├─ DepartureTime: 06:00                                                │
│  ├─ TargetSoC: 90%                                                      │
│  ├─ CurrentSoC: 30%                                                     │
│  └─ EVMaximumDischargePower: 100 kW (V2G sposobnost)                    │
│                                                                          │
│  SECC odgovara sa rasporedom:                                            │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ Unos │ Početak  │ Trajanje │ Snaga    │ Razlog                   │   │
│  ├──────┼──────────┼──────────┼──────────┼──────────────────────────┤   │
│  │   1  │ 18:00    │ 2h       │ +50 kW   │ Jeftina tarifa počinje   │   │
│  │   2  │ 20:00    │ 2h       │ +100 kW  │ Najniža potražnja        │   │
│  │   3  │ 22:00    │ 2h       │ +50 kW   │ Srednja potražnja        │   │
│  │   4  │ 00:00    │ 2h       │ -30 kW   │ V2G: Mrežni vršni događaj│   │
│  │   5  │ 02:00    │ 2h       │ +80 kW   │ Obnovi SoC               │   │
│  │   6  │ 04:00    │ 2h       │ +50 kW   │ Dopuna pre polaska       │   │
│  │   7  │ 06:00    │ -        │ 0 kW     │ Spremno za polazak       │   │
│  └──────┴──────────┴──────────┴──────────┴──────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 DINAMIČKI Režim

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         TOK DINAMIČKOG REŽIMA                            │
│                                                                          │
│  EVCC pruža limite, SECC dinamički podešava snagu:                      │
│                                                                          │
│  Ciklus ChargeLoop (svakih 250ms - 1s):                                 │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ Vreme │ Mreža f │ EVSETargetPower │ EV Odziv      │ Akcija         │ │
│  ├───────┼─────────┼─────────────────┼───────────────┼────────────────┤ │
│  │ 0.0s  │ 50.00   │ +30 kW          │ Puni 30kW     │ Normalno       │ │
│  │ 0.5s  │ 49.95   │ +30 kW          │ Puni 30kW     │ U mrtvoj zoni  │ │
│  │ 1.0s  │ 49.88   │ +15 kW          │ Smanjuje      │ Pod-frekvencija│ │
│  │ 1.5s  │ 49.82   │ 0 kW            │ Mirovanje     │ Ozbiljna pod-f │ │
│  │ 2.0s  │ 49.75   │ -20 kW          │ V2G pražnjenje│ Kritično       │ │
│  │ 2.5s  │ 49.78   │ -20 kW          │ V2G pražnjenje│ Još kritično   │ │
│  │ 3.0s  │ 49.85   │ -10 kW          │ Smanjuje V2G  │ Oporavlja se   │ │
│  │ 3.5s  │ 49.92   │ 0 kW            │ Mirovanje     │ Blizu normalnog│ │
│  │ 4.0s  │ 49.98   │ +15 kW          │ Nastavlja     │ U mrtvoj zoni  │ │
│  │ 4.5s  │ 50.02   │ +30 kW          │ Puni 30kW     │ Normalno       │ │
│  └───────┴─────────┴─────────────────┴───────────────┴────────────────┘ │
│                                                                          │
│  EV MORA odgovoriti na EVSETargetPower u roku od 2 sekunde (ISO 15118-20)│
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. BPT Petlja Punjenja

### 5.1 Razmena Poruka

```
DC_BPT_ChargeLoopReq (EVCC → SECC)
─────────────────────────────────────────────────────────────────────────
{
    // Zahtev snage (pozitivno = punjenje, negativno = pražnjenje)
    EVTargetPower: -20000,           // -20 kW (V2G pražnjenje)
    EVTargetVoltage: 400,            // 400V
    EVTargetCurrent: -50,            // -50A (pražnjenje)

    // Trenutne vrednosti
    EVPresentVoltage: 398,
    EVPresentCurrent: -48,

    // Status
    EVPresentSoC: 65,                // Trenutni SoC
    EVReadyToCharge: true,
    BPT_ChannelSelection: DISCHARGE, // V2G aktivan
}

DC_BPT_ChargeLoopRes (SECC → EVCC)
─────────────────────────────────────────────────────────────────────────
{
    ResponseCode: OK,

    // EVSE trenutne vrednosti
    EVSEPresentVoltage: 399,
    EVSEPresentCurrent: -49,
    EVSEPresentPower: -19551,        // Stvarna snaga

    // Dinamički režim: EVSE može zahtevati promenu snage
    EVSETargetPower: -25000,         // Zahtevaj više V2G!
}
```

### 5.2 Strukture Podataka

```c
// Zahtev petlje punjenja (EVCC → SECC)
typedef struct {
    // Ciljevi snage
    int32_t  EVTargetPower;          // [W], + punjenje, - pražnjenje
    uint16_t EVTargetVoltage;        // [V]
    int16_t  EVTargetCurrent;        // [A], + punjenje, - pražnjenje

    // Trenutna merenja
    uint16_t EVPresentVoltage;       // [V]
    int16_t  EVPresentCurrent;       // [A]

    // Status
    uint8_t  EVPresentSoC;           // [%]
    bool     EVReadyToCharge;
    BPT_Channel BPT_ChannelSelection;

    // Dinamički limiti
    int32_t  EVMaximumChargePower;
    int32_t  EVMaximumDischargePower;

    // Završetak
    bool     ChargingComplete;
} DC_BPT_ChargeLoopReq;

// Odgovor petlje punjenja (SECC → EVCC)
typedef struct {
    // Odgovor
    uint8_t  ResponseCode;

    // Trenutne vrednosti
    uint16_t EVSEPresentVoltage;     // [V]
    int16_t  EVSEPresentCurrent;     // [A]
    int32_t  EVSEPresentPower;       // [W]

    // Zastavice limita
    bool     EVSEPowerLimitAchieved;
    bool     EVSECurrentLimitAchieved;
    bool     EVSEVoltageLimitAchieved;

    // Dinamički režim: zahtev snage od EVSE
    int32_t  EVSETargetPower;        // [W], EVSE može zahtevati promenu
} DC_BPT_ChargeLoopRes;
```

---

## 6. Plug & Charge (PnC) za V2G

### 6.1 Lanac Sertifikata

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    V2G PKI HIJERARHIJA SERTIFIKATA                       │
│                                                                          │
│                    ┌─────────────────────┐                              │
│                    │    V2G Root CA      │ (npr. Hubject)               │
│                    │    (Korenska        │                              │
│                    │     pouzdanost)     │                              │
│                    └──────────┬──────────┘                              │
│                               │                                          │
│              ┌────────────────┼────────────────┐                        │
│              │                │                │                        │
│              ▼                ▼                ▼                        │
│    ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐         │
│    │   CPO Pod-CA    │ │   MO Pod-CA     │ │   OEM Pod-CA    │         │
│    │ (Operator       │ │ (Operator       │ │ (Proizvođač     │         │
│    │  Punjača)       │ │  Mobilnosti)    │ │  Vozila)        │         │
│    └────────┬────────┘ └────────┬────────┘ └────────┬────────┘         │
│             │                   │                   │                   │
│             ▼                   ▼                   ▼                   │
│    ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐         │
│    │  SECC Sert      │ │ Ugovorni Sert   │ │  EVCC Sert      │         │
│    │  (U Punjaču)    │ │ (Korisnički     │ │  (U Vozilu)     │         │
│    │                 │ │  Nalog)         │ │                 │         │
│    └─────────────────┘ └─────────────────┘ └─────────────────┘         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Integracija Sigurnog Elementa

```c
// Interfejs sigurnog elementa (OPTIGA Trust ili slično)
typedef struct {
    uint8_t slot_id;            // Slot sertifikata
    uint8_t key_id;             // ID privatnog ključa
    bool    locked;             // Ključ ne može biti izvezen
} SecureElementKey;

// Skladište sertifikata
typedef struct {
    SecureElementKey contract_key;
    uint8_t contract_cert[2048];
    uint16_t contract_cert_len;

    // EMAID (npr. "DE-ABC-C12345678-9")
    char emaid[32];

    // Dozvole ugovora
    bool bpt_allowed;            // V2G omogućen u ugovoru
    int32_t max_discharge_power; // Ugovorni limit za V2G
} PnC_ContractData;

// Proveri da li ugovor dozvoljava V2G
bool PnC_VerifyBPTPermission(PnC_ContractData* contract,
                             int32_t requested_discharge_power) {
    if (!contract->bpt_allowed) {
        return false;  // Ugovor ne uključuje V2G
    }

    if (requested_discharge_power > contract->max_discharge_power) {
        return false;  // Premašuje ugovorni limit
    }

    return true;
}
```

---

## 7. Upravljanje Greškama

### 7.1 Kodovi Odgovora

```c
typedef enum {
    // Uspeh
    RESPONSE_OK = 0,

    // Greške
    FAILED = 200,
    FAILED_SEQUENCE_ERROR = 201,
    FAILED_CERTIFICATE_EXPIRED = 206,
    FAILED_POWER_DELIVERY_NOT_APPLIED = 216,
} ResponseCode;
```

### 7.2 V2G-Specifične Greške

```c
typedef enum {
    V2G_ERROR_NONE = 0,

    // BPT-specifične greške
    V2G_ERROR_BPT_NOT_SUPPORTED = 300,
    V2G_ERROR_BPT_NOT_AUTHORIZED = 301,
    V2G_ERROR_DISCHARGE_POWER_EXCEEDED = 302,
    V2G_ERROR_SOC_TOO_LOW_FOR_V2G = 303,
    V2G_ERROR_DEPARTURE_TIME_CONFLICT = 304,
    V2G_ERROR_GRID_NOT_READY = 305,
    V2G_ERROR_DYNAMIC_MODE_TIMEOUT = 306,

    // Sigurnosne greške
    V2G_ERROR_ISOLATION_FAULT = 400,
    V2G_ERROR_CONTACTOR_WELDED = 401,
    V2G_ERROR_OVERCURRENT = 402,
    V2G_ERROR_OVERVOLTAGE = 403,
    V2G_ERROR_COMMUNICATION_LOST = 404
} V2G_ErrorCode;
```

---

## 8. Reference

- **ISO 15118-20:2022** - Drumska vozila — Komunikacioni interfejs vozilo-mreža — Deo 20: Zahtevi mrežnog i aplikacionog sloja 2. generacije
- **ISO 15118-2:2014** - Drumska vozila — Komunikacioni interfejs vozilo-mreža — Deo 2: Zahtevi mrežnog i aplikacionog protokola (1. generacija)
- **CharIN DC BPT Vodič za Interoperabilnost v1.0** - Smernice za implementaciju dvosmernog DC punjenja
- **Hubject ISO 15118** - PKI i Plug&Charge dokumentacija ekosistema
