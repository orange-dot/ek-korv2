# ISO 15118-20 Bidirectional Power Transfer (BPT)

This document details the ISO 15118-20 protocol implementation for V2G bidirectional power transfer in the ELEKTROKOMBINACIJA system.

---

## 1. Protocol Overview

### 1.1 ISO 15118 Evolution

```
ISO 15118-2 (2014)              ISO 15118-20 (2022)
────────────────────────────────────────────────────────────────
Unidirectional only         →   Bidirectional Power Transfer (BPT)
AC and DC charging          →   AC, DC, and Wireless charging
Scheduled charging          →   Scheduled AND Dynamic modes
EXI encoding                →   EXI encoding (optimized)
TLS 1.2                     →   TLS 1.3
Limited services            →   Expanded service framework
```

### 1.2 Key V2G Features in ISO 15118-20

| Feature | Description |
|---------|-------------|
| **DC_BPT** | Bidirectional DC power transfer service |
| **Dynamic Mode** | Real-time power adjustment by EVSE |
| **Scheduled Mode** | Pre-planned charging/discharging schedule |
| **Control Mode** | Grid-following or Grid-forming operation |
| **BPT Parameters** | Discharge power limits, energy limits |

### 1.3 Protocol Stack

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  V2G Application Protocol                                          │ │
│  │  ├─ Session Management                                             │ │
│  │  ├─ Service Discovery & Selection                                  │ │
│  │  ├─ Authorization (PnC / EIM)                                      │ │
│  │  ├─ Charge Parameter Discovery                                     │ │
│  │  ├─ Schedule Exchange                                              │ │
│  │  └─ Power Delivery & Charge Loop                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│                        PRESENTATION LAYER                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  EXI (Efficient XML Interchange)                                   │ │
│  │  ├─ Schema-informed encoding                                       │ │
│  │  ├─ Binary XML representation                                      │ │
│  │  └─ ~10x compression vs text XML                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│                          SESSION LAYER                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  TLS 1.3                                                           │ │
│  │  ├─ Mutual authentication (for PnC)                                │ │
│  │  ├─ ECDSA signatures                                               │ │
│  │  └─ AES-GCM encryption                                             │ │
│  └───────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│                         TRANSPORT LAYER                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  TCP/IP                                                            │ │
│  │  ├─ Port 15118 (V2G communication)                                 │ │
│  │  └─ Reliable, ordered delivery                                     │ │
│  └───────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│                          PHYSICAL LAYER                                  │
│  ┌────────────────────────────┐  ┌────────────────────────────┐       │
│  │  HomePlug Green PHY (PLC)  │  │  WiFi (optional)           │       │
│  │  ├─ Over Control Pilot     │  │  ├─ 802.11n                │       │
│  │  ├─ 10 Mbps max            │  │  └─ For wireless charging  │       │
│  │  └─ SLAC association       │  │                            │       │
│  └────────────────────────────┘  └────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Service Discovery and Selection

### 2.1 Available Services

```
ServiceID   Service Name        Description
─────────────────────────────────────────────────────────────────
1           DC                  Unidirectional DC charging
2           DC_ACDP             DC with AC during pause
3           AC                  AC charging
4           AC_BPT              Bidirectional AC (future)
5           WPT                 Wireless Power Transfer
6           DC_BPT              Bidirectional DC ← V2G SERVICE
7           DC_ACDP_BPT         DC ACDP with bidirectional
```

### 2.2 Service Discovery Exchange

```
EVCC (Vehicle)                                    SECC (Charger)
     │                                                 │
     │────── ServiceDiscoveryReq ─────────────────────►│
     │       {                                         │
     │         SupportedServiceIDs: [1, 6]             │
     │       }                                         │
     │                                                 │
     │◄───── ServiceDiscoveryRes ─────────────────────│
     │       {                                         │
     │         ResponseCode: OK,                       │
     │         ServiceList: [                          │
     │           {ServiceID: 1, ServiceName: "DC"},    │
     │           {ServiceID: 6, ServiceName: "DC_BPT"} │ ← V2G available
     │         ],                                      │
     │         ServiceParameterList: [                 │
     │           {ServiceID: 6, ParameterSetID: 1}     │
     │         ]                                       │
     │       }                                         │
     │                                                 │
     │────── ServiceSelectionReq ─────────────────────►│
     │       {                                         │
     │         SelectedServiceList: [                  │
     │           {ServiceID: 6, ParameterSetID: 1}     │ ← Select BPT
     │         ]                                       │
     │       }                                         │
     │                                                 │
     │◄───── ServiceSelectionRes ─────────────────────│
     │       {                                         │
     │         ResponseCode: OK                        │
     │       }                                         │
```

---

## 3. BPT State Machine

### 3.1 Complete State Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       ISO 15118-20 BPT STATE MACHINE                             │
│                                                                                  │
│                              ┌─────────┐                                        │
│                     ┌───────►│  IDLE   │◄────────────────────────────┐          │
│                     │        └────┬────┘                             │          │
│                     │             │ Cable connected                  │          │
│                     │             │ SLAC complete                    │          │
│                     │             ▼                                  │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │ SUPPORTED_APP_   │                        │          │
│                     │   │ PROTOCOL         │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │  SESSION_SETUP   │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │  AUTHORIZATION   │ PnC or EIM             │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │SERVICE_DISCOVERY │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │SERVICE_SELECTION │ Select DC_BPT          │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│    Session          │   │ CHARGE_PARAMETER │ Exchange BPT limits    │          │
│    Renegotiation ───┤   │ DISCOVERY        │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │SCHEDULE_EXCHANGE │ SCHEDULED mode only    │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │   CABLE_CHECK    │ Insulation test        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │   PRE_CHARGE     │ Match battery voltage  │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │ POWER_DELIVERY   │ Close contactors       │          │
│                     │   │ START            │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌────────────────────────────────────────┐  │          │
│                     │   │          DC_BPT_CHARGE_LOOP            │  │          │
│                     │   │  ┌──────────────────────────────────┐  │  │          │
│                     │   │  │                                  │  │  │          │
│                     │   │  │  EVTargetPower > 0 → CHARGING    │  │  │          │
│                     │   │  │  EVTargetPower < 0 → DISCHARGING │◄─┼──┼──┐       │
│                     │   │  │  EVTargetPower = 0 → STANDBY     │  │  │  │       │
│                     │   │  │                                  │──┼──┼──┘       │
│                     │   │  └──────────────────────────────────┘  │  │  loop    │
│                     │   └────────────────────┬───────────────────┘  │          │
│                     │                        │                      │          │
│                     │                        │ ChargingComplete     │          │
│                     │                        │ OR EVTargetPower=0   │          │
│                     │                        ▼                      │          │
│                     │   ┌──────────────────┐                        │          │
│                     │   │ POWER_DELIVERY   │ Open contactors        │          │
│                     │   │ STOP             │                        │          │
│                     │   └────────┬─────────┘                        │          │
│                     │            │                                   │          │
│                     │            ▼                                   │          │
│                     │   ┌──────────────────┐                        │          │
│                     └───│  SESSION_STOP    │────────────────────────┘          │
│                         └──────────────────┘                                    │
│                                                                                  │
│  Legend:                                                                        │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  CHARGING:    Power flows Grid → Battery (EVTargetPower > 0)                   │
│  DISCHARGING: Power flows Battery → Grid (EVTargetPower < 0) [V2G]             │
│  STANDBY:     No power transfer (EVTargetPower = 0)                            │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 State Transitions

| From State | To State | Trigger |
|------------|----------|---------|
| IDLE | SUPPORTED_APP_PROTOCOL | Cable connected, SLAC complete |
| AUTHORIZATION | SERVICE_DISCOVERY | Authorization successful |
| CHARGE_PARAMETER_DISCOVERY | SCHEDULE_EXCHANGE | SCHEDULED mode |
| CHARGE_PARAMETER_DISCOVERY | CABLE_CHECK | DYNAMIC mode |
| DC_BPT_CHARGE_LOOP | POWER_DELIVERY_STOP | ChargingComplete=true |
| DC_BPT_CHARGE_LOOP | CHARGE_PARAMETER_DISCOVERY | Renegotiation request |
| Any state | SESSION_STOP | Error or user abort |

---

## 4. Charge Parameter Discovery

### 4.1 BPT Parameter Exchange

```
EVCC (Vehicle)                                    SECC (Charger)
     │                                                 │
     │──── DC_ChargeParameterDiscoveryReq ────────────►│
     │     {                                           │
     │       // Charging parameters                    │
     │       EVMaximumChargePower: 150000,    // 150kW │
     │       EVMaximumChargeCurrent: 200,     // 200A  │
     │       EVMaximumVoltage: 850,           // 850V  │
     │       EVMinimumVoltage: 250,           // 250V  │
     │                                                 │
     │       // BPT (discharge) parameters             │
     │       EVMaximumDischargePower: 100000, // 100kW │ ← V2G capability
     │       EVMaximumDischargeCurrent: 150,  // 150A  │
     │       EVMinimumDischargePower: 1000,   // 1kW   │
     │                                                 │
     │       // Energy parameters                      │
     │       EVEnergyCapacity: 400000,        // 400kWh│
     │       EVTargetSoC: 90,                 // 90%   │
     │       EVMinimumSoC: 20,                // 20%   │ ← Don't discharge below
     │                                                 │
     │       // Timing                                 │
     │       DepartureTime: "2026-01-05T06:00:00Z"    │
     │     }                                           │
     │                                                 │
     │◄─── DC_ChargeParameterDiscoveryRes ────────────│
     │     {                                           │
     │       ResponseCode: OK,                         │
     │                                                 │
     │       // EVSE charging limits                   │
     │       EVSEMaximumChargePower: 350000,  // 350kW │
     │       EVSEMaximumChargeCurrent: 500,   // 500A  │
     │       EVSEMaximumVoltage: 920,         // 920V  │
     │       EVSEMinimumVoltage: 200,         // 200V  │
     │                                                 │
     │       // EVSE BPT (discharge) limits            │
     │       EVSEMaximumDischargePower: 100000,// 100kW│ ← V2G supported
     │       EVSEMaximumDischargeCurrent: 150, // 150A │
     │       EVSEMinimumDischargePower: 500,   // 500W │
     │                                                 │
     │       // Negotiated values (minimum of EV/EVSE) │
     │       // MaxChargePower = min(150kW, 350kW) = 150kW
     │       // MaxDischargePower = min(100kW, 100kW) = 100kW
     │     }                                           │
```

### 4.2 Data Structures

```c
// EV charge/discharge parameters (from vehicle)
typedef struct {
    // Charging limits
    int32_t  EVMaximumChargePower;       // [W]
    int16_t  EVMaximumChargeCurrent;     // [A]
    uint16_t EVMaximumVoltage;           // [V]
    uint16_t EVMinimumVoltage;           // [V]

    // Discharging limits (V2G)
    int32_t  EVMaximumDischargePower;    // [W]
    int16_t  EVMaximumDischargeCurrent;  // [A]
    int32_t  EVMinimumDischargePower;    // [W]

    // Energy parameters
    int32_t  EVEnergyCapacity;           // [Wh]
    uint8_t  EVTargetSoC;                // [%], 0-100
    uint8_t  EVMinimumSoC;               // [%], V2G floor
    uint8_t  EVCurrentSoC;               // [%], current state

    // Timing
    uint32_t DepartureTime;              // Unix timestamp
} BPT_EVParameters;

// EVSE charge/discharge parameters (from charger)
typedef struct {
    // Charging limits
    int32_t  EVSEMaximumChargePower;     // [W]
    int16_t  EVSEMaximumChargeCurrent;   // [A]
    uint16_t EVSEMaximumVoltage;         // [V]
    uint16_t EVSEMinimumVoltage;         // [V]

    // Discharging limits (V2G)
    int32_t  EVSEMaximumDischargePower;  // [W]
    int16_t  EVSEMaximumDischargeCurrent;// [A]
    int32_t  EVSEMinimumDischargePower;  // [W]

    // Pricing (optional)
    int32_t  EVSEPricePerKWh;            // [0.01 EUR], charging
    int32_t  EVSEPricePerKWhDischarge;   // [0.01 EUR], V2G payment
} BPT_EVSEParameters;

// Negotiated session parameters
typedef struct {
    int32_t  MaxChargePower;             // min(EV, EVSE)
    int32_t  MaxDischargePower;          // min(EV, EVSE)
    int16_t  MaxChargeCurrent;
    int16_t  MaxDischargeCurrent;
    uint16_t MaxVoltage;
    uint16_t MinVoltage;
} BPT_NegotiatedParameters;
```

---

## 5. Control Modes

### 5.1 SCHEDULED Mode

In Scheduled mode, EVSE provides a charging/discharging schedule upfront. The EV follows this schedule.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        SCHEDULED MODE FLOW                               │
│                                                                          │
│  EVCC sends:                                                             │
│  ├─ DepartureTime: 06:00                                                │
│  ├─ TargetSoC: 90%                                                      │
│  ├─ CurrentSoC: 30%                                                     │
│  └─ EVMaximumDischargePower: 100 kW (V2G capability)                    │
│                                                                          │
│  SECC responds with schedule:                                            │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ Entry │ Start    │ Duration │ Power    │ Reason                  │   │
│  ├───────┼──────────┼──────────┼──────────┼─────────────────────────┤   │
│  │   1   │ 18:00    │ 2h       │ +50 kW   │ Off-peak tariff starts  │   │
│  │   2   │ 20:00    │ 2h       │ +100 kW  │ Lowest demand           │   │
│  │   3   │ 22:00    │ 2h       │ +50 kW   │ Medium demand           │   │
│  │   4   │ 00:00    │ 2h       │ -30 kW   │ V2G: Grid peak event    │   │
│  │   5   │ 02:00    │ 2h       │ +80 kW   │ Restore SoC             │   │
│  │   6   │ 04:00    │ 2h       │ +50 kW   │ Top-up before departure │   │
│  │   7   │ 06:00    │ -        │ 0 kW     │ Departure ready         │   │
│  └───────┴──────────┴──────────┴──────────┴─────────────────────────┘   │
│                                                                          │
│  Power (kW)                                                              │
│     ▲                                                                    │
│ +100│      ┌───┐                                                        │
│     │      │   │                                                        │
│  +50│  ┌───┘   └───┐           ┌───────┐  ┌───┐                        │
│     │  │           │           │       │  │   │                        │
│    0├──┴───────────┴───────────┴───────┴──┴───┴────► Time              │
│     │                 ┌───┐                                              │
│  -30│                 │V2G│                                              │
│     └─────────────────┴───┴─────────────────────                        │
│     18:00  20:00  22:00  00:00  02:00  04:00  06:00                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 DYNAMIC Mode

In Dynamic mode, EVSE can request power changes in real-time during the charge loop.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         DYNAMIC MODE FLOW                                │
│                                                                          │
│  EVCC provides limits, SECC adjusts power dynamically:                  │
│                                                                          │
│  ChargeLoop cycle (every 250ms - 1s):                                   │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ Time  │ Grid f │ EVSETargetPower │ EV Response   │ Action          │ │
│  ├───────┼────────┼─────────────────┼───────────────┼─────────────────┤ │
│  │ 0.0s  │ 50.00  │ +30 kW          │ Charging 30kW │ Normal          │ │
│  │ 0.5s  │ 49.95  │ +30 kW          │ Charging 30kW │ In deadband     │ │
│  │ 1.0s  │ 49.88  │ +15 kW          │ Ramping down  │ Under-frequency │ │
│  │ 1.5s  │ 49.82  │ 0 kW            │ Standby       │ Severe under-f  │ │
│  │ 2.0s  │ 49.75  │ -20 kW          │ V2G discharge │ Critical        │ │
│  │ 2.5s  │ 49.78  │ -20 kW          │ V2G discharge │ Still critical  │ │
│  │ 3.0s  │ 49.85  │ -10 kW          │ Reducing V2G  │ Recovering      │ │
│  │ 3.5s  │ 49.92  │ 0 kW            │ Standby       │ Near normal     │ │
│  │ 4.0s  │ 49.98  │ +15 kW          │ Resume charge │ In deadband     │ │
│  │ 4.5s  │ 50.02  │ +30 kW          │ Charging 30kW │ Normal          │ │
│  └───────┴────────┴─────────────────┴───────────────┴─────────────────┘ │
│                                                                          │
│  Grid Frequency                        Power                             │
│     ▲                                    ▲                               │
│ 50.1│                                +30│───┐           ┌───            │
│     │─────┐                             │   │           │               │
│ 50.0│     │                          +15│   │       ┌───┘               │
│     │     │      ┌─────┐                │   └───┐   │                   │
│ 49.9│     └──────┘     │              0 │───────┴───┘                   │
│     │                  │                │                               │
│ 49.8│                  └───┐         -10│       ┌───┐                   │
│     │                      │            │       │   │                   │
│ 49.7│                      └───        -20│───────┘   └───               │
│     └─────────────────────────► t        └───────────────────► t        │
│                                                                          │
│  EV MUST respond to EVSETargetPower within 2 seconds (ISO 15118-20)     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.3 Control Mode Selection

```c
typedef enum {
    CONTROL_MODE_SCHEDULED = 0,
    CONTROL_MODE_DYNAMIC = 1
} ControlMode;

typedef enum {
    BPT_CHANNEL_CHARGE = 0,      // Grid → Battery
    BPT_CHANNEL_DISCHARGE = 1    // Battery → Grid (V2G)
} BPT_Channel;

// Mode selection logic
ControlMode SelectControlMode(BPT_EVParameters* ev, BPT_EVSEParameters* evse) {
    // Dynamic mode required for:
    // - Frequency regulation
    // - Demand response
    // - Real-time grid services

    // Scheduled mode preferred for:
    // - Overnight fleet charging
    // - Known departure times
    // - Predictable load management

    if (evse->GridServicesEnabled && ev->EVMaximumDischargePower > 0) {
        return CONTROL_MODE_DYNAMIC;  // V2G with grid services
    }

    if (ev->DepartureTime > 0) {
        return CONTROL_MODE_SCHEDULED;  // Known schedule
    }

    return CONTROL_MODE_DYNAMIC;  // Default to dynamic
}
```

---

## 6. BPT Charge Loop

### 6.1 Message Exchange

```
DC_BPT_ChargeLoopReq (EVCC → SECC)
─────────────────────────────────────────────────────────────────────────
{
    // Power request (positive = charge, negative = discharge)
    EVTargetPower: -20000,           // -20 kW (V2G discharge)
    EVTargetVoltage: 400,            // 400V
    EVTargetCurrent: -50,            // -50A (discharging)

    // Present values
    EVPresentVoltage: 398,
    EVPresentCurrent: -48,

    // Status
    EVPresentSoC: 65,                // Current SoC
    EVReadyToCharge: true,
    BPT_ChannelSelection: DISCHARGE, // V2G active

    // Dynamic limits (may change during session)
    EVMaximumChargePower: 150000,
    EVMaximumDischargePower: 100000,
    EVMinimumChargePower: 500,
    EVMinimumDischargePower: 500,

    // Optional: Display message
    DisplayParameters: {
        PresentSoC: 65,
        RemainingTimeToTargetSoC: 180,  // minutes
        ChargingComplete: false
    }
}

DC_BPT_ChargeLoopRes (SECC → EVCC)
─────────────────────────────────────────────────────────────────────────
{
    ResponseCode: OK,

    // EVSE present values
    EVSEPresentVoltage: 399,
    EVSEPresentCurrent: -49,
    EVSEPresentPower: -19551,        // Actual power

    // EVSE status
    EVSEPowerLimitAchieved: false,
    EVSECurrentLimitAchieved: false,
    EVSEVoltageLimitAchieved: false,

    // Dynamic mode: EVSE can request power change
    EVSETargetPower: -25000,         // Request more V2G!

    // Limits (may change during session)
    EVSEMaximumChargePower: 350000,
    EVSEMaximumDischargePower: 100000,

    // Metering
    MeterInfo: {
        MeterID: "EVSE001",
        MeterReading: 12345678,      // Wh total
        MeterStatus: VALID
    }
}
```

### 6.2 Data Structures

```c
// Charge loop request (EVCC → SECC)
typedef struct {
    // Power targets
    int32_t  EVTargetPower;          // [W], + charge, - discharge
    uint16_t EVTargetVoltage;        // [V]
    int16_t  EVTargetCurrent;        // [A], + charge, - discharge

    // Present measurements
    uint16_t EVPresentVoltage;       // [V]
    int16_t  EVPresentCurrent;       // [A]

    // Status
    uint8_t  EVPresentSoC;           // [%]
    bool     EVReadyToCharge;
    BPT_Channel BPT_ChannelSelection;

    // Dynamic limits
    int32_t  EVMaximumChargePower;
    int32_t  EVMaximumDischargePower;
    int32_t  EVMinimumChargePower;
    int32_t  EVMinimumDischargePower;

    // Completion
    bool     ChargingComplete;
} DC_BPT_ChargeLoopReq;

// Charge loop response (SECC → EVCC)
typedef struct {
    // Response
    uint8_t  ResponseCode;

    // Present values
    uint16_t EVSEPresentVoltage;     // [V]
    int16_t  EVSEPresentCurrent;     // [A]
    int32_t  EVSEPresentPower;       // [W]

    // Limit flags
    bool     EVSEPowerLimitAchieved;
    bool     EVSECurrentLimitAchieved;
    bool     EVSEVoltageLimitAchieved;

    // Dynamic mode: power request from EVSE
    int32_t  EVSETargetPower;        // [W], EVSE can request change

    // Dynamic limits
    int32_t  EVSEMaximumChargePower;
    int32_t  EVSEMaximumDischargePower;
} DC_BPT_ChargeLoopRes;
```

### 6.3 Charge Loop State Machine

```c
typedef enum {
    LOOP_STATE_IDLE,
    LOOP_STATE_CHARGING,
    LOOP_STATE_DISCHARGING,
    LOOP_STATE_STANDBY,
    LOOP_STATE_RAMP_UP,
    LOOP_STATE_RAMP_DOWN,
    LOOP_STATE_COMPLETE,
    LOOP_STATE_ERROR
} ChargeLoopState;

typedef struct {
    ChargeLoopState state;
    ControlMode mode;

    // Targets
    int32_t target_power;
    int32_t actual_power;
    uint16_t target_voltage;

    // Timing
    uint32_t loop_interval_ms;       // 250-1000ms
    uint32_t last_loop_time;
    uint32_t response_timeout_ms;    // 2000ms max

    // Limits
    int32_t max_charge_power;
    int32_t max_discharge_power;
    int32_t ramp_rate;               // W/s

    // Status
    bool evse_power_request_pending;
    int32_t evse_requested_power;
} BPT_ChargeLoop;

void BPT_ChargeLoop_Init(BPT_ChargeLoop* loop, ControlMode mode) {
    loop->state = LOOP_STATE_IDLE;
    loop->mode = mode;
    loop->target_power = 0;
    loop->actual_power = 0;
    loop->loop_interval_ms = 500;    // 500ms default
    loop->response_timeout_ms = 2000;
    loop->ramp_rate = 10000;         // 10 kW/s default
    loop->evse_power_request_pending = false;
}

void BPT_ChargeLoop_Process(BPT_ChargeLoop* loop,
                            DC_BPT_ChargeLoopReq* req,
                            DC_BPT_ChargeLoopRes* res) {
    // 1. Handle EVSE power request (Dynamic mode)
    if (loop->mode == CONTROL_MODE_DYNAMIC && res->EVSETargetPower != 0) {
        loop->evse_power_request_pending = true;
        loop->evse_requested_power = res->EVSETargetPower;
    }

    // 2. Update target power
    if (loop->evse_power_request_pending) {
        loop->target_power = loop->evse_requested_power;
        loop->evse_power_request_pending = false;
    }

    // 3. Apply ramp rate
    int32_t power_diff = loop->target_power - loop->actual_power;
    int32_t max_step = loop->ramp_rate * loop->loop_interval_ms / 1000;

    if (abs(power_diff) > max_step) {
        loop->actual_power += (power_diff > 0) ? max_step : -max_step;
    } else {
        loop->actual_power = loop->target_power;
    }

    // 4. Update state
    if (loop->actual_power > 100) {
        loop->state = LOOP_STATE_CHARGING;
    } else if (loop->actual_power < -100) {
        loop->state = LOOP_STATE_DISCHARGING;
    } else {
        loop->state = LOOP_STATE_STANDBY;
    }

    // 5. Check completion
    if (req->ChargingComplete || req->EVPresentSoC >= 100) {
        loop->state = LOOP_STATE_COMPLETE;
    }
}

bool BPT_ChargeLoop_ShouldStop(BPT_ChargeLoop* loop) {
    return (loop->state == LOOP_STATE_COMPLETE ||
            loop->state == LOOP_STATE_ERROR);
}
```

---

## 7. Plug & Charge (PnC) for V2G

### 7.1 Certificate Chain

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    V2G PKI CERTIFICATE HIERARCHY                         │
│                                                                          │
│                    ┌─────────────────────┐                              │
│                    │    V2G Root CA      │ (e.g., Hubject)              │
│                    │    (Trust Anchor)   │                              │
│                    └──────────┬──────────┘                              │
│                               │                                          │
│              ┌────────────────┼────────────────┐                        │
│              │                │                │                        │
│              ▼                ▼                ▼                        │
│    ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐         │
│    │   CPO Sub-CA    │ │  MO Sub-CA      │ │  OEM Sub-CA     │         │
│    │ (Charge Point   │ │ (Mobility       │ │ (Vehicle        │         │
│    │  Operator)      │ │  Operator)      │ │  Manufacturer)  │         │
│    └────────┬────────┘ └────────┬────────┘ └────────┬────────┘         │
│             │                   │                   │                   │
│             ▼                   ▼                   ▼                   │
│    ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐         │
│    │  SECC Cert      │ │ Contract Cert   │ │  EVCC Cert      │         │
│    │  (In Charger)   │ │ (User Account)  │ │  (In Vehicle)   │         │
│    └─────────────────┘ └─────────────────┘ └─────────────────┘         │
│                                                                          │
│  Certificate Contents:                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│  Contract Cert:                                                         │
│    - EMAID (E-Mobility Account Identifier)                              │
│    - Public key (ECDSA P-256)                                           │
│    - Validity period                                                    │
│    - Contract details (included/excluded services)                      │
│                                                                          │
│  SECC Cert:                                                             │
│    - EVSEID (EVSE Identifier)                                           │
│    - CPO information                                                    │
│    - Location                                                           │
│    - Supported services (including DC_BPT for V2G)                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 PnC Authentication Flow

```
EVCC (Vehicle)                                    SECC (Charger)
     │                                                 │
     │◄────────────── TLS Handshake ─────────────────►│
     │    (Mutual authentication with certificates)    │
     │                                                 │
     │────── AuthorizationSetupReq ───────────────────►│
     │       {                                         │
     │         AuthorizationMode: PnC                  │
     │       }                                         │
     │                                                 │
     │◄───── AuthorizationSetupRes ───────────────────│
     │       {                                         │
     │         CertificateInstallService: Available,   │
     │         PnC_ASResAuthorizationMode: Supported   │
     │       }                                         │
     │                                                 │
     │────── AuthorizationReq ────────────────────────►│
     │       {                                         │
     │         GenChallenge: <random>,                 │
     │         ContractCertificateChain: {...}         │
     │       }                                         │
     │                                                 │
     │         [SECC validates certificate chain]      │
     │         [SECC checks EMAID authorization]       │
     │         [SECC verifies V2G contract allows BPT] │
     │                                                 │
     │◄───── AuthorizationRes ────────────────────────│
     │       {                                         │
     │         ResponseCode: OK,                       │
     │         EVSEProcessing: Finished,               │
     │         AuthorizationStatus: Accepted           │
     │       }                                         │
     │                                                 │
     │         [Proceed to ServiceDiscovery]           │
```

### 7.3 Secure Element Integration

```c
// Secure element interface (OPTIGA Trust or similar)
typedef struct {
    uint8_t slot_id;            // Certificate slot
    uint8_t key_id;             // Private key ID
    bool    locked;             // Key cannot be exported
} SecureElementKey;

// Certificate storage
typedef struct {
    SecureElementKey contract_key;
    uint8_t contract_cert[2048];
    uint16_t contract_cert_len;

    uint8_t sub_ca_cert[1024];
    uint16_t sub_ca_cert_len;

    // EMAID (e.g., "DE-ABC-C12345678-9")
    char emaid[32];

    // Contract permissions
    bool bpt_allowed;            // V2G enabled in contract
    int32_t max_discharge_power; // Contract limit for V2G
} PnC_ContractData;

// Sign authorization challenge
int PnC_SignChallenge(SecureElementKey* key,
                      const uint8_t* challenge, size_t challenge_len,
                      uint8_t* signature, size_t* signature_len) {
    // ECDSA-SHA256 signature using secure element
    // Private key never leaves the secure element
    return SecureElement_Sign(key->slot_id, key->key_id,
                              challenge, challenge_len,
                              signature, signature_len);
}

// Verify contract allows V2G
bool PnC_VerifyBPTPermission(PnC_ContractData* contract,
                             int32_t requested_discharge_power) {
    if (!contract->bpt_allowed) {
        return false;  // Contract doesn't include V2G
    }

    if (requested_discharge_power > contract->max_discharge_power) {
        return false;  // Exceeds contract limit
    }

    return true;
}
```

---

## 8. Complete Implementation

### 8.1 BPT Session Manager

```c
typedef enum {
    BPT_SESSION_STATE_IDLE,
    BPT_SESSION_STATE_SETUP,
    BPT_SESSION_STATE_AUTH,
    BPT_SESSION_STATE_SERVICE_DISCOVERY,
    BPT_SESSION_STATE_PARAM_DISCOVERY,
    BPT_SESSION_STATE_SCHEDULE_EXCHANGE,
    BPT_SESSION_STATE_CABLE_CHECK,
    BPT_SESSION_STATE_PRE_CHARGE,
    BPT_SESSION_STATE_POWER_DELIVERY,
    BPT_SESSION_STATE_CHARGE_LOOP,
    BPT_SESSION_STATE_STOP,
    BPT_SESSION_STATE_ERROR
} BPT_SessionState;

typedef struct {
    // State
    BPT_SessionState state;
    ControlMode control_mode;
    bool bpt_enabled;

    // Session ID
    uint8_t session_id[8];

    // Parameters
    BPT_EVParameters ev_params;
    BPT_EVSEParameters evse_params;
    BPT_NegotiatedParameters negotiated;

    // Charge loop
    BPT_ChargeLoop charge_loop;

    // Timing
    uint32_t session_start_time;
    uint32_t state_entry_time;
    uint32_t state_timeout_ms;

    // Authorization
    PnC_ContractData contract;
    bool authorized;

    // Metering
    int32_t energy_charged_wh;
    int32_t energy_discharged_wh;

    // Error handling
    uint8_t error_code;
    char error_message[64];
} BPT_Session;

void BPT_Session_Init(BPT_Session* session) {
    memset(session, 0, sizeof(BPT_Session));
    session->state = BPT_SESSION_STATE_IDLE;
    session->state_timeout_ms = 60000;  // 60s default timeout
}

void BPT_Session_ProcessMessage(BPT_Session* session,
                                 uint8_t msg_type,
                                 const uint8_t* msg_data,
                                 size_t msg_len) {
    switch (session->state) {
        case BPT_SESSION_STATE_SERVICE_DISCOVERY:
            if (msg_type == MSG_SERVICE_DISCOVERY_RES) {
                ServiceDiscoveryRes* res = (ServiceDiscoveryRes*)msg_data;

                // Check if DC_BPT is available
                for (int i = 0; i < res->service_count; i++) {
                    if (res->services[i].service_id == SERVICE_ID_DC_BPT) {
                        session->bpt_enabled = true;
                        break;
                    }
                }

                // Select service
                if (session->bpt_enabled) {
                    BPT_Session_SelectService(session, SERVICE_ID_DC_BPT);
                } else {
                    BPT_Session_SelectService(session, SERVICE_ID_DC);
                }

                session->state = BPT_SESSION_STATE_PARAM_DISCOVERY;
            }
            break;

        case BPT_SESSION_STATE_PARAM_DISCOVERY:
            if (msg_type == MSG_CHARGE_PARAM_DISCOVERY_RES) {
                DC_ChargeParameterDiscoveryRes* res =
                    (DC_ChargeParameterDiscoveryRes*)msg_data;

                // Store EVSE parameters
                session->evse_params.EVSEMaximumChargePower =
                    res->EVSEMaximumChargePower;
                session->evse_params.EVSEMaximumDischargePower =
                    res->EVSEMaximumDischargePower;

                // Negotiate parameters
                session->negotiated.MaxChargePower = MIN(
                    session->ev_params.EVMaximumChargePower,
                    session->evse_params.EVSEMaximumChargePower);
                session->negotiated.MaxDischargePower = MIN(
                    session->ev_params.EVMaximumDischargePower,
                    session->evse_params.EVSEMaximumDischargePower);

                // Select control mode
                session->control_mode = SelectControlMode(
                    &session->ev_params, &session->evse_params);

                if (session->control_mode == CONTROL_MODE_SCHEDULED) {
                    session->state = BPT_SESSION_STATE_SCHEDULE_EXCHANGE;
                } else {
                    session->state = BPT_SESSION_STATE_CABLE_CHECK;
                }
            }
            break;

        case BPT_SESSION_STATE_CHARGE_LOOP:
            if (msg_type == MSG_DC_BPT_CHARGE_LOOP_RES) {
                DC_BPT_ChargeLoopRes* res = (DC_BPT_ChargeLoopRes*)msg_data;

                // Process response
                DC_BPT_ChargeLoopReq req;
                BPT_Session_BuildChargeLoopReq(session, &req);

                BPT_ChargeLoop_Process(&session->charge_loop, &req, res);

                // Update metering
                if (res->EVSEPresentPower > 0) {
                    session->energy_charged_wh +=
                        res->EVSEPresentPower * session->charge_loop.loop_interval_ms / 3600000;
                } else {
                    session->energy_discharged_wh +=
                        (-res->EVSEPresentPower) * session->charge_loop.loop_interval_ms / 3600000;
                }

                // Check for completion
                if (BPT_ChargeLoop_ShouldStop(&session->charge_loop)) {
                    session->state = BPT_SESSION_STATE_STOP;
                }
            }
            break;

        // ... other states
    }
}

void BPT_Session_BuildChargeLoopReq(BPT_Session* session,
                                    DC_BPT_ChargeLoopReq* req) {
    req->EVTargetPower = session->charge_loop.actual_power;
    req->EVTargetVoltage = session->charge_loop.target_voltage;
    req->EVTargetCurrent = session->charge_loop.actual_power /
                           session->charge_loop.target_voltage;

    req->EVPresentSoC = session->ev_params.EVCurrentSoC;
    req->EVReadyToCharge = true;

    req->BPT_ChannelSelection = (session->charge_loop.actual_power < 0) ?
                                 BPT_CHANNEL_DISCHARGE : BPT_CHANNEL_CHARGE;

    req->EVMaximumChargePower = session->ev_params.EVMaximumChargePower;
    req->EVMaximumDischargePower = session->ev_params.EVMaximumDischargePower;

    req->ChargingComplete = (session->ev_params.EVCurrentSoC >=
                             session->ev_params.EVTargetSoC);
}
```

---

## 9. Error Handling

### 9.1 Response Codes

```c
typedef enum {
    // Success
    RESPONSE_OK = 0,
    RESPONSE_OK_NEW_SESSION_ESTABLISHED = 1,
    RESPONSE_OK_OLD_SESSION_JOINED = 2,
    RESPONSE_OK_CERTIFICATE_EXPIRES_SOON = 3,

    // Warnings
    WARNING_CERTIFICATE_VALIDATION = 100,
    WARNING_NO_CERTIFICATE_AVAILABLE = 101,

    // Failures
    FAILED = 200,
    FAILED_SEQUENCE_ERROR = 201,
    FAILED_SERVICE_ID_INVALID = 202,
    FAILED_UNKNOWN_SESSION = 203,
    FAILED_SERVICE_SELECTION_INVALID = 204,
    FAILED_PAYMENT_SELECTION_INVALID = 205,
    FAILED_CERTIFICATE_EXPIRED = 206,
    FAILED_SIGNATURE_ERROR = 207,
    FAILED_NO_CERTIFICATE_AVAILABLE = 208,
    FAILED_CERTIFICATE_REVOKED = 209,
    FAILED_CERTIFICATE_NOT_YET_VALID = 210,
    FAILED_CERTIFICATE_CHAIN_ERROR = 211,
    FAILED_CHALLENGE_INVALID = 212,
    FAILED_CONTRACT_CANCELLED = 213,
    FAILED_WRONG_ENERGY_TRANSFER_MODE = 214,
    FAILED_WRONG_CHARGE_PARAMETER = 215,
    FAILED_POWER_DELIVERY_NOT_APPLIED = 216,
    FAILED_TARIFF_SELECTION_INVALID = 217,
    FAILED_CHARGING_PROFILE_INVALID = 218,
    FAILED_EVSE_PRESENT_VOLTAGE_TO_LOW = 219,
    FAILED_METERING_SIGNATURE_NOT_VALID = 220,
    FAILED_NO_TARIFF_DATA_AVAILABLE = 221
} ResponseCode;

const char* ResponseCode_ToString(ResponseCode code) {
    switch (code) {
        case RESPONSE_OK: return "OK";
        case FAILED_SEQUENCE_ERROR: return "Sequence Error";
        case FAILED_CERTIFICATE_EXPIRED: return "Certificate Expired";
        case FAILED_POWER_DELIVERY_NOT_APPLIED: return "Power Delivery Failed";
        // ... etc
        default: return "Unknown";
    }
}
```

### 9.2 V2G-Specific Errors

```c
typedef enum {
    V2G_ERROR_NONE = 0,

    // BPT-specific errors
    V2G_ERROR_BPT_NOT_SUPPORTED = 300,
    V2G_ERROR_BPT_NOT_AUTHORIZED = 301,
    V2G_ERROR_DISCHARGE_POWER_EXCEEDED = 302,
    V2G_ERROR_SOC_TOO_LOW_FOR_V2G = 303,
    V2G_ERROR_DEPARTURE_TIME_CONFLICT = 304,
    V2G_ERROR_GRID_NOT_READY = 305,
    V2G_ERROR_DYNAMIC_MODE_TIMEOUT = 306,

    // Safety errors
    V2G_ERROR_ISOLATION_FAULT = 400,
    V2G_ERROR_CONTACTOR_WELDED = 401,
    V2G_ERROR_OVERCURRENT = 402,
    V2G_ERROR_OVERVOLTAGE = 403,
    V2G_ERROR_COMMUNICATION_LOST = 404
} V2G_ErrorCode;

void BPT_Session_HandleError(BPT_Session* session, V2G_ErrorCode error) {
    session->error_code = error;

    switch (error) {
        case V2G_ERROR_SOC_TOO_LOW_FOR_V2G:
            // SoC dropped below minimum - stop V2G, switch to charging
            session->charge_loop.target_power = 0;
            snprintf(session->error_message, sizeof(session->error_message),
                     "SoC below V2G minimum (%d%%)", session->ev_params.EVMinimumSoC);
            break;

        case V2G_ERROR_DYNAMIC_MODE_TIMEOUT:
            // EV didn't respond to EVSE power request in time
            session->charge_loop.target_power = 0;
            session->state = BPT_SESSION_STATE_STOP;
            break;

        case V2G_ERROR_ISOLATION_FAULT:
        case V2G_ERROR_CONTACTOR_WELDED:
        case V2G_ERROR_OVERCURRENT:
            // Critical safety error - immediate stop
            session->state = BPT_SESSION_STATE_ERROR;
            // Open contactors immediately
            break;

        default:
            break;
    }
}
```

---

## 10. References

- **ISO 15118-20:2022** - Road vehicles — Vehicle to grid communication interface — Part 20: 2nd generation network layer and application layer requirements
- **ISO 15118-2:2014** - Road vehicles — Vehicle to grid communication interface — Part 2: Network and application protocol requirements (1st generation)
- **CharIN DC BPT Interoperability Guide v1.0** - Implementation guidelines for bidirectional DC charging
- **Hubject ISO 15118** - PKI and Plug&Charge ecosystem documentation
- **HomePlug Green PHY** - Powerline communication specification for EV charging
