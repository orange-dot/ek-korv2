// =============================================================================
// ESP32-S3 Platform Description for Renode
// JEZGRO Development - WiFi/Connectivity Node
// =============================================================================
// NOTE: ESP32-S3 support in Renode is PARTIAL
// Xtensa LX7 cores are emulated, but many peripherals are stubs
// Use Wokwi or QEMU for more complete ESP32 simulation
// =============================================================================

// -----------------------------------------------------------------------------
// CPU Cores - Dual Xtensa LX7
// -----------------------------------------------------------------------------

// Note: Renode v1.14+ has Xtensa support
cpu0: CPU.Xtensa @ sysbus
    cpuType: "lx7"
    // ESP32-S3 runs at up to 240 MHz

// CPU1 can be added for SMP simulation
// cpu1: CPU.Xtensa @ sysbus
//     cpuType: "lx7"

// -----------------------------------------------------------------------------
// Memory Regions
// -----------------------------------------------------------------------------

// Internal ROM (First stage bootloader)
rom: Memory.MappedMemory @ sysbus 0x40000000
    size: 0x60000        // 384 KB

// Internal SRAM (Data)
sram0: Memory.MappedMemory @ sysbus 0x3FC88000
    size: 0x78000        // 480 KB

// Internal SRAM (Instruction)
iram: Memory.MappedMemory @ sysbus 0x40370000
    size: 0x70000        // 448 KB

// RTC Fast Memory
rtc_fast: Memory.MappedMemory @ sysbus 0x600FE000
    size: 0x2000         // 8 KB

// RTC Slow Memory
rtc_slow: Memory.MappedMemory @ sysbus 0x50000000
    size: 0x2000         // 8 KB

// External Flash (via SPI, memory mapped)
flash: Memory.MappedMemory @ sysbus 0x3C000000
    size: 0x800000       // 8 MB (typical)

// External PSRAM (optional)
psram: Memory.MappedMemory @ sysbus 0x3D000000
    size: 0x800000       // 8 MB

// -----------------------------------------------------------------------------
// UARTs
// -----------------------------------------------------------------------------

uart0: UART.ESP32_UART @ sysbus 0x60000000
    // -> cpu0@? (interrupt routing TBD)

uart1: UART.ESP32_UART @ sysbus 0x60010000

uart2: UART.ESP32_UART @ sysbus 0x6002D000

// -----------------------------------------------------------------------------
// GPIO
// -----------------------------------------------------------------------------

gpio: Python.PythonPeripheral @ sysbus 0x60004000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    OUT = 0x00000000
    OUT_W1TS = 0x00000000
    OUT_W1TC = 0x00000000
    ENABLE = 0x00000000
    IN = 0x00000000
    log("GPIO: Initialized")

if request.isRead:
    if request.offset == 0x04:    # OUT
        request.value = OUT
    elif request.offset == 0x3C:  # IN
        request.value = IN
    elif request.offset == 0x20:  # ENABLE
        request.value = ENABLE
    else:
        request.value = 0

if request.isWrite:
    if request.offset == 0x04:    # OUT
        OUT = request.value
    elif request.offset == 0x08:  # OUT_W1TS
        OUT |= request.value
    elif request.offset == 0x0C:  # OUT_W1TC
        OUT &= ~request.value
    elif request.offset == 0x20:  # ENABLE
        ENABLE = request.value
'''

// -----------------------------------------------------------------------------
// Timers
// -----------------------------------------------------------------------------

timg0: Python.PythonPeripheral @ sysbus 0x6001F000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    T0CONFIG = 0x00000000
    T0LO = 0x00000000
    T0HI = 0x00000000
    WDTCONFIG0 = 0x00000000
if request.isRead:
    if request.offset == 0x00:
        request.value = T0CONFIG
    elif request.offset == 0x04:
        request.value = T0LO
    elif request.offset == 0x08:
        request.value = T0HI
    else:
        request.value = 0
if request.isWrite:
    if request.offset == 0x00:
        T0CONFIG = request.value
'''

timg1: Python.PythonPeripheral @ sysbus 0x60020000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    T0CONFIG = 0x00000000
if request.isRead:
    request.value = 0
'''

// -----------------------------------------------------------------------------
// System Timer (SYSTIMER)
// -----------------------------------------------------------------------------

systimer: Python.PythonPeripheral @ sysbus 0x60023000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    CONF = 0x00000000
    UNIT0_VALUE_LO = 0x00000000
    UNIT0_VALUE_HI = 0x00000000
    counter = 0
if request.isRead:
    if request.offset == 0x00:    # CONF
        request.value = CONF
    elif request.offset == 0x04:  # UNIT0_OP
        request.value = 0
    elif request.offset == 0x0C:  # UNIT0_VALUE_LO
        request.value = counter & 0xFFFFFFFF
    elif request.offset == 0x10:  # UNIT0_VALUE_HI
        request.value = (counter >> 32) & 0xFFFFFFFF
    else:
        request.value = 0
if request.isWrite:
    if request.offset == 0x00:
        CONF = request.value
'''

// -----------------------------------------------------------------------------
// Interrupt Controller
// -----------------------------------------------------------------------------

intc: Python.PythonPeripheral @ sysbus 0x600C2000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    CPU_INT_ENABLE = 0x00000000
    CPU_INT_TYPE = 0x00000000
    CPU_INT_PRI = [0] * 32
if request.isRead:
    if request.offset == 0x104:   # CPU_INT_ENABLE
        request.value = CPU_INT_ENABLE
    else:
        request.value = 0
if request.isWrite:
    if request.offset == 0x104:
        CPU_INT_ENABLE = request.value
'''

// -----------------------------------------------------------------------------
// SPI Controllers
// -----------------------------------------------------------------------------

spi2: Python.PythonPeripheral @ sysbus 0x60024000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    CMD = 0x00000000
    CTRL = 0x00000000
if request.isRead:
    if request.offset == 0x00:
        request.value = CMD
    else:
        request.value = 0
if request.isWrite:
    if request.offset == 0x00:
        CMD = request.value
'''

spi3: Python.PythonPeripheral @ sysbus 0x60025000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    CMD = 0x00000000
if request.isRead:
    request.value = 0
'''

// -----------------------------------------------------------------------------
// I2C Controllers
// -----------------------------------------------------------------------------

i2c0: Python.PythonPeripheral @ sysbus 0x60013000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    CTR = 0x00000003
    SR = 0x00000000
if request.isRead:
    if request.offset == 0x04:    # CTR
        request.value = CTR
    elif request.offset == 0x08:  # SR
        request.value = SR
    else:
        request.value = 0
if request.isWrite:
    if request.offset == 0x04:
        CTR = request.value
'''

i2c1: Python.PythonPeripheral @ sysbus 0x60027000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    CTR = 0x00000003
if request.isRead:
    request.value = 0
'''

// -----------------------------------------------------------------------------
// WiFi / BLE - STUB
// -----------------------------------------------------------------------------
// Note: WiFi and BLE are NOT emulated in Renode
// For WiFi testing, use:
// - Wokwi simulator (web-based, has WiFi simulation)
// - Real hardware with mock network
// - Unit tests with mocked WiFi HAL

wifi: Python.PythonPeripheral @ sysbus 0x60033000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    log("WiFi: STUB - No actual WiFi emulation")
if request.isRead:
    request.value = 0
'''

// -----------------------------------------------------------------------------
// TWAI (CAN) Controller
// -----------------------------------------------------------------------------

twai: Python.PythonPeripheral @ sysbus 0x6002B000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    MODE = 0x00000001      # Reset mode
    CMD = 0x00000000
    STATUS = 0x00000000
    INT_RAW = 0x00000000
    INT_ENA = 0x00000000
    BUS_TIMING_0 = 0x00000000
    BUS_TIMING_1 = 0x00000000
    log("TWAI (CAN): Initialized in reset mode")

if request.isRead:
    if request.offset == 0x00:     # MODE
        request.value = MODE
    elif request.offset == 0x04:   # CMD
        request.value = CMD
    elif request.offset == 0x08:   # STATUS
        request.value = STATUS | 0x04  # TX buffer available
    elif request.offset == 0x0C:   # INT_RAW
        request.value = INT_RAW
    elif request.offset == 0x10:   # INT_ENA
        request.value = INT_ENA
    elif request.offset == 0x18:   # BUS_TIMING_0
        request.value = BUS_TIMING_0
    elif request.offset == 0x1C:   # BUS_TIMING_1
        request.value = BUS_TIMING_1
    else:
        request.value = 0

if request.isWrite:
    if request.offset == 0x00:     # MODE
        old_mode = MODE
        MODE = request.value
        if (old_mode & 0x01) and not (request.value & 0x01):
            log("TWAI: Exiting reset mode - operational")
        elif not (old_mode & 0x01) and (request.value & 0x01):
            log("TWAI: Entering reset mode")
    elif request.offset == 0x04:   # CMD
        CMD = request.value
        if request.value & 0x01:   # TX request
            log("TWAI: TX requested")
    elif request.offset == 0x10:   # INT_ENA
        INT_ENA = request.value
    elif request.offset == 0x18:   # BUS_TIMING_0
        BUS_TIMING_0 = request.value
    elif request.offset == 0x1C:   # BUS_TIMING_1
        BUS_TIMING_1 = request.value
'''

// -----------------------------------------------------------------------------
// RTC Controller (simplified)
// -----------------------------------------------------------------------------

rtc_cntl: Python.PythonPeripheral @ sysbus 0x60008000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    OPTIONS0 = 0x00000000
    SLP_TIMER0 = 0x00000000
    TIME_UPDATE = 0x00000000
if request.isRead:
    request.value = 0
'''

// -----------------------------------------------------------------------------
// System Registers
// -----------------------------------------------------------------------------

system: Python.PythonPeripheral @ sysbus 0x600C0000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    CPU_PERI_CLK_EN = 0xFFFFFFFF
    CPU_PERI_RST_EN = 0x00000000
    SYSCLK_CONF = 0x00000001
if request.isRead:
    if request.offset == 0x00:
        request.value = CPU_PERI_CLK_EN
    elif request.offset == 0x04:
        request.value = CPU_PERI_RST_EN
    elif request.offset == 0x60:
        request.value = SYSCLK_CONF
    else:
        request.value = 0
if request.isWrite:
    if request.offset == 0x00:
        CPU_PERI_CLK_EN = request.value
    elif request.offset == 0x04:
        CPU_PERI_RST_EN = request.value
'''

// -----------------------------------------------------------------------------
// eFuse Controller
// -----------------------------------------------------------------------------

efuse: Python.PythonPeripheral @ sysbus 0x60007000
    size: 0x1000
    initable: true
    script: '''
if request.isInit:
    # Simulated eFuse values
    RD_MAC_SPI_SYS_0 = 0x12345678  # Fake MAC
    RD_MAC_SPI_SYS_1 = 0x0000ABCD
if request.isRead:
    if request.offset == 0x44:
        request.value = RD_MAC_SPI_SYS_0
    elif request.offset == 0x48:
        request.value = RD_MAC_SPI_SYS_1
    else:
        request.value = 0
'''

// -----------------------------------------------------------------------------
// Bus Tags
// -----------------------------------------------------------------------------

sysbus:
    init:
        Tag <0x60000000, 0x60000FFF> "UART0"
        Tag <0x60004000, 0x60004FFF> "GPIO"
        Tag <0x60007000, 0x60007FFF> "EFUSE"
        Tag <0x60008000, 0x60008FFF> "RTC_CNTL"
        Tag <0x60010000, 0x60010FFF> "UART1"
        Tag <0x60013000, 0x60013FFF> "I2C0"
        Tag <0x6001F000, 0x6001FFFF> "TIMG0"
        Tag <0x60020000, 0x60020FFF> "TIMG1"
        Tag <0x60023000, 0x60023FFF> "SYSTIMER"
        Tag <0x60024000, 0x60024FFF> "SPI2"
        Tag <0x60025000, 0x60025FFF> "SPI3"
        Tag <0x60027000, 0x60027FFF> "I2C1"
        Tag <0x6002B000, 0x6002BFFF> "TWAI"
        Tag <0x6002D000, 0x6002DFFF> "UART2"
        Tag <0x60033000, 0x60033FFF> "WIFI (stub)"
        Tag <0x600C0000, 0x600C0FFF> "SYSTEM"
        Tag <0x600C2000, 0x600C2FFF> "INTC"
